<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Location Collector</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- XLSX (SheetJS) for Excel file reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- QRCode.js for QR code generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', 'Cairo', 'sans-serif';
            background-color: #f1f5f9; /* slate-100 */
        }
        .btn {
            @apply font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:shadow-lg hover:-translate-y-px focus:outline-none focus:ring-2 focus:ring-offset-2 border border-transparent;
        }
        .btn-primary {
            @apply bg-gradient-to-br from-indigo-500 to-blue-600 text-white hover:from-indigo-600 hover:to-blue-700 focus:ring-indigo-500 disabled:opacity-60 disabled:shadow-none disabled:transform-none disabled:cursor-not-allowed;
        }
        .btn-secondary {
            @apply bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 hover:border-slate-400 focus:ring-slate-300 disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed disabled:shadow-none disabled:transform-none;
        }
        .btn-export-collected {
            @apply bg-gradient-to-br from-violet-500 to-purple-600 text-white hover:from-violet-600 hover:to-purple-700 focus:ring-violet-500 disabled:opacity-60 disabled:shadow-none disabled:transform-none disabled:cursor-not-allowed;
        }
        .btn-export-merged {
             @apply bg-gradient-to-br from-teal-500 to-cyan-600 text-white hover:from-teal-600 hover:to-cyan-700 focus:ring-teal-500 disabled:opacity-60 disabled:shadow-none disabled:transform-none disabled:cursor-not-allowed;
        }
        .btn-export-geojson {
            @apply bg-gradient-to-br from-emerald-500 to-green-600 text-white hover:from-emerald-600 hover:to-green-700 focus:ring-emerald-500 disabled:opacity-60 disabled:shadow-none disabled:transform-none disabled:cursor-not-allowed;
        }
        .btn-danger {
            @apply bg-gradient-to-br from-rose-500 to-red-600 text-white hover:from-rose-600 hover:to-red-700 focus:ring-rose-500 disabled:opacity-60 disabled:shadow-none disabled:transform-none disabled:cursor-not-allowed;
        }
        .table-header-cell {
            @apply px-6 py-3 text-right text-xs font-bold text-slate-600 uppercase tracking-wider;
        }
        .table-body-cell {
            @apply px-6 py-4 whitespace-nowrap;
        }
        .tab-button {
            @apply whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200;
        }
        .tab-button-active {
            @apply border-indigo-500 text-indigo-600;
        }
        .tab-button-inactive {
            @apply border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 1rem;
                background: white;
            }
            .no-print {
                display: none !important;
            }
        }

    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>
    
    <script type="module">
        import React from 'react';
        import ReactDOM from 'react-dom/client';

        // A shorthand for React.createElement to make the code more readable
        const e = React.createElement;

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBAzpt2uoNjI0fQ4m45mgYLj0Mdq3mnVd4",
          authDomain: "industrials-s.firebaseapp.com",
          databaseURL: "https://industrials-s-default-rtdb.firebaseio.com",
          projectId: "industrials-s",
          storageBucket: "industrials-s.firebasestorage.app",
          messagingSenderId: "676050382843",
          appId: "1:676050382843:web:81b4cc47e2a1e5c7b3255e",
          measurementId: "G-0BWB3T2V2J"
        };
        
        // Initialize Firebase
        window.firebase.initializeApp(firebaseConfig);
        
        // =====================================================================================
        // --- services/conversion.ts ---
        // =====================================================================================
        function extractCoordinates(url) {
            const patterns = [/@(-?\d+\.\d+),(-?\d+\.\d+)/, /!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/, /ll=(-?\d+\.\d+),(-?\d+\.\d+)/, /maps\?q=(-?\d+\.\d+),(-?\d+\.\d+)/];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    return { lat: parseFloat(match[1]), lon: parseFloat(match[2]) };
                }
            }
            return null;
        }
        
        // =====================================================================================
        // --- components/Alert.tsx ---
        // =====================================================================================
        const Alert = ({ message, type }) => {
            const baseClasses = 'p-4 rounded-xl shadow-2xl flex items-center border-l-4 w-full max-w-md';
            const typeClasses = {
                success: 'bg-emerald-50 border-emerald-500 text-emerald-900',
                error: 'bg-rose-50 border-rose-500 text-rose-900',
            };
            const icon = {
                success: e('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-6 w-6 ml-3 text-emerald-500", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" }, e('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" })),
                error: e('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-6 w-6 ml-3 text-rose-500", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" }, e('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" })),
            };
            return e('div', { className: `${baseClasses} ${typeClasses[type]}`, role: "alert" }, icon[type], e('p', { className: "font-semibold" }, message));
        };

        // =====================================================================================
        // --- components/EmptyState.tsx ---
        // =====================================================================================
        const EmptyState = ({ message }) => {
            return e('div', { className: "text-center py-16 px-6 bg-slate-50 rounded-lg" },
                e('svg', { className: "mx-auto h-16 w-16 text-slate-400", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", "aria-hidden": "true" },
                    e('path', { vectorEffect: "non-scaling-stroke", strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 1.5, d: "M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" })
                ),
                e('h3', { className: "mt-4 text-lg font-medium text-slate-800" }, "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª"),
                e('p', { className: "mt-2 text-sm text-slate-500" }, message)
            );
        };

        // =====================================================================================
        // --- components/Header.tsx ---
        // =====================================================================================
        const Header = ({ title, recordCount }) => {
            return e('header', { className: "bg-gradient-to-r from-slate-800 to-slate-900 shadow-lg sticky top-0 z-40 text-white" },
                e('div', { className: "container mx-auto px-4 md:px-6 py-4 flex justify-between items-center" },
                    e('div', { className: "flex items-center gap-4" },
                        e('h1', { className: "text-2xl font-bold tracking-wider" }, title)
                    ),
                    e('div', { className: "bg-white/10 text-white text-sm font-semibold px-5 py-2 rounded-full backdrop-blur-sm border border-white/20" }, `ðŸ“Š Ø§Ù„ØªÙ‚Ø¯Ù…: ${recordCount}`)
                )
            );
        };
        
        // =====================================================================================
        // --- components/CollectionPage.tsx ---
        // =====================================================================================
        const CollectionPage = ({ isAdmin, onAdminLogin, onAdminLogout, referenceData, fileName }) => {
            const { useState, useMemo, useEffect } = React;
            const [collectedLocations, setCollectedLocations] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [selectedGovernorate, setSelectedGovernorate] = useState('');
            const [selectedLocationMasterIndex, setSelectedLocationMasterIndex] = useState('');
            const [googleLink, setGoogleLink] = useState('');
            const [coordinates, setCoordinates] = useState(null);
            const [alert, setAlert] = useState(null);
            const [isPasswordModalOpen, setIsPasswordModalOpen] = useState(false);
            const [passwordInput, setPasswordInput] = useState('');
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [uploadMode, setUploadMode] = useState('replace'); // 'replace' or 'append'
            const [activeTab, setActiveTab] = useState('collected');
            const [isQrModalOpen, setIsQrModalOpen] = useState(false);
            const [qrCodeData, setQrCodeData] = useState(null);

            useEffect(() => {
                if (window.firebase && window.firebase.database) {
                     setIsFirebaseReady(true);
                }
            }, []);
            
            useEffect(() => {
                if (!isFirebaseReady) return;
                const db = window.firebase.database();
                const recordsRef = db.ref('collectedLocations/');
                const listener = recordsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    const loadedRecords = [];
                    if (data) {
                        for (const key in data) {
                            loadedRecords.push({ id: key, ...data[key] });
                        }
                    }
                    setCollectedLocations(loadedRecords.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()));
                });
                return () => recordsRef.off('value', listener);
            }, [isFirebaseReady]);

            useEffect(() => {
                if (isQrModalOpen && qrCodeData) {
                    const canvas = document.getElementById('qrcode-canvas');
                    if (canvas && window.QRCode) {
                        const googleMapsUrl = `https://www.google.com/maps?q=${qrCodeData.latitude},${qrCodeData.longitude}`;
                        window.QRCode.toCanvas(canvas, googleMapsUrl, { width: 224, margin: 1 }, (error) => {
                            if (error) {
                                console.error('QR Code generation failed:', error);
                                showAlert('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©.', 'error');
                            }
                        });
                    }
                }
            }, [isQrModalOpen, qrCodeData]);

            const showAlert = (message, type) => {
                setAlert({ message, type });
                setTimeout(() => setAlert(null), 5000); 
            };

            const handlePasswordSubmit = (ev) => {
                ev.preventDefault();
                if (passwordInput === 'admin@789') {
                    onAdminLogin();
                    showAlert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                    setIsPasswordModalOpen(false);
                    setPasswordInput('');
                } else {
                    showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', 'error');
                    setPasswordInput('');
                }
            };
            
            const handleFileChange = (event) => {
                const file = event.target.files?.[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e_reader) => {
                    try {
                        const data = new Uint8Array(e_reader.target?.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        
                        if (json.length === 0) {
                            showAlert('Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙˆØ¹ ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡ØªÙ‡.', 'error');
                            return;
                        }

                        const requiredCols = ['Company Name', 'Governate', 'Location Name', 'Location Type'];
                        const fileHeaders = Object.keys(json[0]).map(h => h.trim());
                        
                        const missingCols = requiredCols.filter(c => !fileHeaders.includes(c));
                        if (missingCols.length > 0) {
                            showAlert(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©. Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: [${requiredCols.join(', ')}]. Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©: [${missingCols.join(', ')}].`, 'error');
                            return;
                        }
                        
                        const hasIdColumn = fileHeaders.includes('ID');
                        
                        const normalizedData = json.map((row, index) => {
                            const newRow = {};
                            for (const key in row) {
                                newRow[key.trim()] = row[key];
                            }
                            if (!hasIdColumn) {
                                newRow['ID'] = `generated_${index}`;
                            }
                            return newRow;
                        });

                        if (!isFirebaseReady) {
                            showAlert('Ø®Ø¯Ù…Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©.', 'error');
                            return;
                        }
                        const db = window.firebase.database();

                        if (uploadMode === 'append') {
                            if (referenceData.length === 0) {
                                showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„ÙŠÙ‡Ø§. Ø§Ø³ØªØ®Ø¯Ù… ÙˆØ¶Ø¹ "Ø§Ø³ØªØ¨Ø¯Ø§Ù„" Ø£ÙˆÙ„Ø§Ù‹.', 'error');
                                return;
                            }
                            
                            const existingIds = new Set(referenceData.map(row => row.ID));
                            const newIds = normalizedData.map(row => row.ID);
                            const duplicateIds = newIds.filter(id => existingIds.has(id));

                            if (duplicateIds.length > 0) {
                                showAlert(`Ø®Ø·Ø£: ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ IDs Ù…ÙƒØ±Ø±Ø©: [${duplicateIds.join(', ')}]. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ø¶Ø§ÙØ©.`, 'error');
                                return;
                            }
                            
                            const combinedData = [...referenceData, ...normalizedData];
                            const payload = {
                                fileName: `Ù…Ù„Ù Ù…Ø¯Ù…Ø¬ (Ø¢Ø®Ø± Ø¥Ø¶Ø§ÙØ©: ${file.name})`,
                                data: combinedData,
                                uploadedAt: new Date().toISOString()
                            };
                            db.ref('masterReference').set(payload)
                                .then(() => {
                                    showAlert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                                })
                                .catch((error) => {
                                    showAlert(`ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
                                });

                        } else { // 'replace' mode
                            const payload = {
                                fileName: file.name,
                                data: normalizedData,
                                uploadedAt: new Date().toISOString()
                            };
                            db.ref('masterReference').set(payload)
                                .then(() => {
                                    showAlert('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ ÙˆÙ…Ø´Ø§Ø±ÙƒØªÙ‡ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                                })
                                .catch((error) => {
                                    showAlert(`ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${error.message}`, 'error');
                                });
                        }

                    } catch (error) {
                        showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ù…Ù„Ù Ø¥ÙƒØ³Ù„ ØµØ§Ù„Ø­.', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
                event.target.value = '';
            };


            const resetForm = () => {
                setSelectedLocationMasterIndex('');
                setGoogleLink('');
                setCoordinates(null);
                setEditingId(null);
            };

            const handleSubmit = async (ev) => {
                ev.preventDefault();
                const coords = extractCoordinates(googleLink);
                if (!coords) { showAlert('Ø±Ø§Ø¨Ø· Google Maps ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', 'error'); return; }
                if (!isFirebaseReady) { showAlert('Ø®Ø¯Ù…Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©.', 'error'); return; }
                
                const masterRecord = referenceData[parseInt(selectedLocationMasterIndex, 10)];
                if (!masterRecord) { showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ ØµØ§Ù„Ø­.', 'error'); return; }

                const db = window.firebase.database();
                
                const recordData = {
                    masterId: masterRecord.ID,
                    companyName: masterRecord['Company Name'],
                    governate: masterRecord['Governate'],
                    locationName: masterRecord['Location Name'],
                    locationType: masterRecord['Location Type'],
                    latitude: coords.lat.toFixed(7),
                    longitude: coords.lon.toFixed(7),
                };

                if (editingId) {
                    const recordToUpdate = collectedLocations.find(r => r.id === editingId);
                    if (!recordToUpdate) return;
                    const updatedRecord = { ...recordToUpdate, ...recordData, updated: new Date().toLocaleString('ar-EG') };
                    await db.ref(`collectedLocations/${editingId}`).set(updatedRecord);
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                } else {
                    const newRecord = { ...recordData, timestamp: new Date().toLocaleString('ar-EG') };
                    await db.ref('collectedLocations').push(newRecord);
                    showAlert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                }
                resetForm();
            };

            const handleEdit = (record) => {
                setEditingId(record.id); 
                setSelectedGovernorate(record.governate || '');
                setGoogleLink(`https://www.google.com/maps?q=${record.latitude},${record.longitude}`);
                setCoordinates({ lat: record.latitude, lon: record.longitude });
                
                const refIndex = referenceData.findIndex(item => item['ID'] === record.masterId);
                if (refIndex !== -1) {
                    setSelectedLocationMasterIndex(refIndex.toString());
                } else {
                    showAlert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£ØµÙ„ÙŠ ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ.', 'error');
                }
                document.getElementById('data-entry-form')?.scrollIntoView({ behavior: 'smooth' });
            };

            const handleDelete = async (id) => {
                if (window.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù„Ù„Ø¬Ù…ÙŠØ¹.')) {
                    if (!isFirebaseReady) { showAlert('Ø®Ø¯Ù…Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©.', 'error'); return; }
                    const db = window.firebase.database();
                    await db.ref(`collectedLocations/${id}`).remove();
                    showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„.', 'success');
                }
            };

            const handleClearAll = async () => {
                if (window.confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                     if (!isFirebaseReady) { showAlert('Ø®Ø¯Ù…Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©.', 'error'); return; }
                    const db = window.firebase.database();
                    await db.ref('collectedLocations').set(null);
                    showAlert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©.', 'success');
                }
            };
            
            const exportMergedToExcel = () => {
                if (collectedLocations.length === 0 || referenceData.length === 0) { showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¯Ù…Ø¬Ù‡Ø§ Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ.', 'error'); return; }
                const updatedData = JSON.parse(JSON.stringify(referenceData));
                const locationsMap = new Map();
                collectedLocations.forEach(r => locationsMap.set(r.masterId, r));
                
                updatedData.forEach(item => {
                    if (locationsMap.has(item.ID)) {
                        const collected = locationsMap.get(item.ID);
                        item['Long-WGS-84'] = collected.longitude;
                        item['Lat-WGS-84'] = collected.latitude;
                    }
                });

                const ws = XLSX.utils.json_to_sheet(updatedData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Mapped Locations");
                XLSX.writeFile(wb, `mapped_locations_${new Date().toISOString().split('T')[0]}.xlsx`);
                showAlert('ØªÙ… Ø¯Ù…Ø¬ ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            };

            const exportCollectedToExcel = () => {
                if (collectedLocations.length === 0) { showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø¬Ù…Ø¹Ø© Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.', 'error'); return; }
                const data = collectedLocations.map(r => ({
                    'ID': r.masterId,
                    'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©': r.companyName,
                    'Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©': r.governate,
                    'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹': r.locationName,
                    'Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹': r.locationType,
                    'Ø®Ø· Ø§Ù„Ø·ÙˆÙ„': r.longitude,
                    'Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶': r.latitude,
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©': r.timestamp
                })).reverse();
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Collected Records");
                XLSX.writeFile(wb, `collected_locations_${new Date().toISOString().split('T')[0]}.xlsx`);
                showAlert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            };
            
            const exportToGeoJSON = () => {
                if (collectedLocations.length === 0) {
                    showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø¬Ù…Ø¹Ø© Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.', 'error');
                    return;
                }

                const geojson = {
                    type: "FeatureCollection",
                    features: collectedLocations.map(record => ({
                        type: "Feature",
                        geometry: {
                            type: "Point",
                            coordinates: [parseFloat(record.longitude), parseFloat(record.latitude)]
                        },
                        properties: {
                            masterId: record.masterId,
                            companyName: record.companyName,
                            governate: record.governate,
                            locationName: record.locationName,
                            locationType: record.locationType,
                            timestamp: record.timestamp,
                            updated: record.updated || null
                        }
                    }))
                };

                const dataStr = JSON.stringify(geojson, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `collected_locations_${new Date().toISOString().split('T')[0]}.geojson`;

                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showAlert('ØªÙ… ØªØµØ¯ÙŠØ± Ù…Ù„Ù GeoJSON Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            };

            const governorates = useMemo(() => [...new Set(referenceData.map(item => item['Governate']))].filter(Boolean), [referenceData]);
            
            const collectedMasterIds = useMemo(() => new Set(collectedLocations.map(loc => loc.masterId)), [collectedLocations]);

            const locationsForDropdown = useMemo(() => {
                if (!selectedGovernorate) return [];
                return referenceData
                    .map((item, index) => ({ item, index }))
                    .filter(({ item }) => item['Governate'] === selectedGovernorate);
            }, [referenceData, selectedGovernorate]);
            
            const pendingLocations = useMemo(() => {
                if (!referenceData || referenceData.length === 0) return [];
                return referenceData.filter(item => !collectedMasterIds.has(item.ID));
            }, [referenceData, collectedMasterIds]);

            const currentlyEditingMasterId = useMemo(() => {
                if (!editingId) return null;
                const record = collectedLocations.find(l => l.id === editingId);
                return record ? record.masterId : null;
            }, [editingId, collectedLocations]);

            const handleGovernorateChange = (ev) => {
                setSelectedGovernorate(ev.target.value);
                resetForm();
            };

            const handleLocationChange = (ev) => {
                const indexStr = ev.target.value;
                setSelectedLocationMasterIndex(indexStr);
            };

            const handleLinkPaste = (ev) => {
                const pastedText = ev.clipboardData.getData('text');
                setGoogleLink(pastedText);
                const coords = extractCoordinates(pastedText);
                if (coords) setCoordinates(coords);
            };

            const handleLinkChange = (ev) => {
                const newLink = ev.target.value;
                setGoogleLink(newLink);
                const coords = extractCoordinates(newLink);
                setCoordinates(coords);
            };
            
            const handleShowQrCode = (record) => {
                setQrCodeData(record);
                setIsQrModalOpen(true);
            };
    
            const handlePrintQrCode = () => {
                window.print();
            };

            const passwordModal = isPasswordModalOpen && e('div', { className: "fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50" },
                e('div', { className: "bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all" },
                    e('h3', { className: "text-xl font-bold mb-4 text-slate-800" }, "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„"),
                    e('p', { className: "text-sm text-slate-600 mb-6" }, "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©."),
                    e('form', { onSubmit: handlePasswordSubmit },
                        e('input', { type: "password", value: passwordInput, onChange: (ev) => setPasswordInput(ev.target.value), className: "w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white", autoFocus: true }),
                        e('div', { className: "mt-8 flex justify-end gap-3" },
                            e('button', { type: "button", onClick: () => { setIsPasswordModalOpen(false); setPasswordInput(''); }, className: "btn btn-secondary" }, "Ø¥Ù„ØºØ§Ø¡"),
                            e('button', { type: "submit", className: "btn btn-primary" }, "Ø¯Ø®ÙˆÙ„")
                        )
                    )
                )
            );
            
            const qrCodeModal = isQrModalOpen && qrCodeData && e('div', { className: "fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50", onClick: () => setIsQrModalOpen(false) },
                e('div', { className: "bg-white p-8 rounded-xl shadow-2xl w-full max-w-xs transform transition-all text-center", onClick: e => e.stopPropagation() },
                    e('div', { className: 'printable-area' },
                        e('h3', { className: "text-xl font-bold mb-2 text-slate-800" }, "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹"),
                        e('p', { className: "text-sm text-slate-500 mb-6" }, "Ø§Ù…Ø³Ø­ Ø§Ù„Ø±Ù…Ø² Ù„ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„"),
                        e('canvas', { id: 'qrcode-canvas', className: "mx-auto rounded-lg" }),
                        e('div', { className: 'mt-6 text-right w-full space-y-2' },
                            e('p', null, e('span', {className: "font-semibold text-slate-600"}, "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹: "), e('span', {className: "text-slate-800 font-medium"}, qrCodeData.locationName)),
                            e('p', null, e('span', {className: "font-semibold text-slate-600"}, "Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©: "), e('span', {className: "text-slate-800 font-medium"}, qrCodeData.governate)),
                            e('div', { className: "pt-2 border-t" }, 
                                e('p', {className: "font-mono text-xs"}, e('span', {className: "font-semibold text-slate-600"}, "Lat: "), e('span', {className: "text-indigo-700"}, qrCodeData.latitude)),
                                e('p', {className: "font-mono text-xs"}, e('span', {className: "font-semibold text-slate-600"}, "Lon: "), e('span', {className: "text-indigo-700"}, qrCodeData.longitude))
                            )
                        )
                    ),
                    e('div', { className: "mt-8 flex justify-end gap-3 no-print" },
                        e('button', { type: "button", onClick: () => setIsQrModalOpen(false), className: "btn btn-secondary" }, "Ø¥ØºÙ„Ø§Ù‚"),
                        e('button', { type: "button", onClick: handlePrintQrCode, className: "btn btn-primary" }, "Ø·Ø¨Ø§Ø¹Ø©")
                    )
                )
            );
            
            const selectedMasterRecord = useMemo(() => {
                if (selectedLocationMasterIndex === '') return null;
                return referenceData[parseInt(selectedLocationMasterIndex, 10)];
            }, [selectedLocationMasterIndex, referenceData]);

            // --- Updated dropdown styles ---
            const formInputClasses = "w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-slate-50 text-slate-900 hover:border-slate-400 transition-colors disabled:bg-slate-200 disabled:text-slate-500 disabled:cursor-not-allowed";

            const formElement = e('form', { onSubmit: handleSubmit },
                e('label', { className: "block text-sm font-semibold text-slate-700 mb-2" }, "Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"),
                e('div', { className: "space-y-4" },
                    e('div', null, e('label', { htmlFor: "governorate", className: "block text-sm font-medium text-slate-700 mb-1" }, "Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© *"), e('select', { id: "governorate", value: selectedGovernorate, onChange: handleGovernorateChange, className: formInputClasses, required: true }, e('option', { value: "" }, "Ø§Ø®ØªØ± Ù…Ø­Ø§ÙØ¸Ø©..."), governorates.map(g => e('option', { key: g, value: g }, g)))),
                    e('div', null, e('label', { htmlFor: "locationName", className: "block text-sm font-medium text-slate-700 mb-1" }, "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ *"), 
                        e('select', { id: "locationName", value: selectedLocationMasterIndex, onChange: handleLocationChange, className: formInputClasses, disabled: !selectedGovernorate, required: true }, 
                            e('option', { value: "" }, "Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹..."), 
                            locationsForDropdown.map(({ item, index }) => {
                                const isCollected = collectedMasterIds.has(item.ID);
                                const isCurrentlyEditing = item.ID === currentlyEditingMasterId;
                                return e('option', { 
                                    key: item.ID, 
                                    value: index,
                                    disabled: isCollected && !isCurrentlyEditing,
                                    className: isCollected && !isCurrentlyEditing ? 'text-gray-400' : ''
                                }, `${isCollected && !isCurrentlyEditing ? 'âœ… ' : ''}${item['Location Name']}`);
                            })
                        )
                    ),
                    selectedMasterRecord && e('div', { className: "p-4 bg-slate-50 border-l-4 border-slate-300 rounded-md text-sm space-y-1" },
                        e('p', null, e('span', {className: "font-semibold text-slate-600"}, "Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©: "), e('span', {className: "text-slate-800"}, selectedMasterRecord['Company Name'])),
                        e('p', null, e('span', {className: "font-semibold text-slate-600"}, "Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹: "), e('span', {className: "text-slate-800"}, selectedMasterRecord['Location Type']))
                    ),
                    e('div', null, e('label', { htmlFor: "googleLink", className: "block text-sm font-medium text-slate-700 mb-1" }, "Ø±Ø§Ø¨Ø· Google Maps *"), e('textarea', { id: "googleLink", value: googleLink, onChange: handleLinkChange, onPaste: handleLinkPaste, rows: 3, className: `${formInputClasses} bg-white`, placeholder: "Ø§Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª...", required: true })),
                    coordinates && e('div', { className: "p-4 bg-indigo-50 border-l-4 border-indigo-400 text-indigo-900 rounded-lg shadow-sm" }, e('p', { className: "font-semibold" }, "âœ“ ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­:"), e('p', { className: "font-mono text-sm mt-1" }, `Lat = ${coordinates.lat.toFixed(7)}`), e('p', { className: "font-mono text-sm" }, `Lon = ${coordinates.lon.toFixed(7)}`))
                ),
                e('div', { className: "mt-6 space-y-3" },
                    e('button', { type: "submit", disabled: !selectedLocationMasterIndex, className: "w-full btn btn-primary" }, editingId ? 'ðŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„' : 'âœ… Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©'),
                    editingId && e('button', { type: "button", onClick: resetForm, className: "w-full btn btn-secondary" }, "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„")
                )
            );
            
            return e(React.Fragment, null,
                alert && e('div', { className: "fixed top-5 left-1/2 -translate-x-1/2 z-50 w-full max-w-md px-4" }, e(Alert, { message: alert.message, type: alert.type })),
                passwordModal,
                qrCodeModal,
                e(Header, { title: " Ø¬Ø§Ù…Ø¹ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª", recordCount: `${collectedLocations.length} / ${referenceData.length}` }),
                e('main', { className: "container mx-auto p-4 md:p-6" },
                    e('div', { className: "grid grid-cols-1 lg:grid-cols-3 gap-8" },
                        e('div', { id: "data-entry-form", className: "lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit sticky top-24" },
                            e('div', { className: "flex justify-between items-center border-b border-slate-200 pb-4 mb-6" },
                                e('h2', { className: "text-xl font-bold text-slate-800" }, "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…"),
                                isAdmin ? e('div', { className: "flex items-center gap-3" }, e('span', { className: "text-xs font-bold text-emerald-700 bg-emerald-100 px-3 py-1 rounded-full" }, "ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„"), e('button', { onClick: onAdminLogout, className: "text-sm text-rose-600 hover:underline font-semibold" }, "Ø®Ø±ÙˆØ¬")) : e('button', { onClick: () => setIsPasswordModalOpen(true), className: "text-sm text-indigo-600 hover:underline font-semibold" }, "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„")
                            ),
                            isAdmin && e('div', { className: "mb-6" },
                                e('label', { className: "block text-sm font-semibold text-slate-700 mb-2" }, "Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ"),
                                e('div', { className: "flex items-center space-x-6 rtl:space-x-reverse mb-4" },
                                    e('div', { className: "flex items-center" },
                                        e('input', { id: "mode-replace", name: "upload-mode", type: "radio", checked: uploadMode === 'replace', onChange: () => setUploadMode('replace'), className: "focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" }),
                                        e('label', { htmlFor: "mode-replace", className: "mr-2 block text-sm font-medium text-gray-700" }, "Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
                                    ),
                                    e('div', { className: "flex items-center" },
                                        e('input', { id: "mode-append", name: "upload-mode", type: "radio", checked: uploadMode === 'append', onChange: () => setUploadMode('append'), className: "focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" }),
                                        e('label', { htmlFor: "mode-append", className: "mr-2 block text-sm font-medium text-gray-700" }, "Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
                                    )
                                ),
                                e('div', { className: "mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-lg" }, e('div', { className: "space-y-1 text-center" }, e('svg', { className: "mx-auto h-12 w-12 text-slate-400", stroke: "currentColor", fill: "none", viewBox: "0 0 48 48", "aria-hidden": "true" }, e('path', { d: "M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" })), e('div', { className: "flex text-sm text-slate-600 justify-center" }, e('label', { htmlFor: "file-upload", className: "relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 p-1" }, e('span', null, fileName ? 'ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù„Ù' : 'Ø§Ø®ØªØ± Ù…Ù„Ù Ø¥ÙƒØ³Ù„'), e('input', { id: "file-upload", name: "file-upload", type: "file", className: "sr-only", accept: ".xlsx, .xls", onChange: handleFileChange }))), e('p', { className: "text-xs text-slate-500" }, "XLSX, XLS up to 10MB"))),
                                fileName && e('p', { className: "text-sm text-emerald-700 font-semibold mt-3 text-center" }, `âœ“ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: ${fileName}`)
                            ),
                            !isAdmin && referenceData.length === 0 && e('div', { className: "p-4 text-center bg-slate-100 rounded-lg" }, e('p', { className: "text-slate-600" }, "ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©... Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ù…Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù.")),
                            referenceData.length > 0 && formElement
                        ),
                        e('div', { className: "lg:col-span-2 bg-white p-6 rounded-xl shadow-lg" },
                            e('div', { className: "flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4" },
                                e('div', null, e('h2', { className: "text-xl font-bold text-slate-800" }, "Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"), e('p', { className: "text-sm text-slate-500 mt-1" }, "Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ø±Ø¦ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ.")),
                                e('div', { className: "grid grid-cols-2 sm:flex sm:flex-row gap-2 justify-end w-full sm:w-auto" },
                                    e('button', { onClick: exportCollectedToExcel, disabled: collectedLocations.length === 0, className: "btn btn-export-collected" }, "ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø¬Ù…Ø¹"),
                                    e('button', { onClick: exportMergedToExcel, disabled: collectedLocations.length === 0 || referenceData.length === 0, className: "btn btn-export-merged" }, "ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø¯Ù…Ø¬"),
                                    isAdmin && e('button', { onClick: exportToGeoJSON, disabled: collectedLocations.length === 0, className: "btn btn-export-geojson" }, "ØªØµØ¯ÙŠØ± GeoJSON"),
                                    isAdmin && e('button', { onClick: handleClearAll, disabled: collectedLocations.length === 0, className: "btn btn-danger col-span-2" }, "Ø­Ø°Ù Ø§Ù„ÙƒÙ„")
                                )
                            ),
                            e('div', { className: "border-b border-gray-200 mb-4" },
                                e('nav', { className: "-mb-px flex space-x-8 rtl:space-x-reverse", "aria-label": "Tabs" },
                                    e('button', { onClick: () => setActiveTab('collected'), className: `tab-button ${activeTab === 'collected' ? 'tab-button-active' : 'tab-button-inactive'}` }, `Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© (${collectedLocations.length})`),
                                    e('button', { onClick: () => setActiveTab('pending'), className: `tab-button ${activeTab === 'pending' ? 'tab-button-active' : 'tab-button-inactive'}` }, `Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© (${pendingLocations.length})`)
                                )
                            ),
                            activeTab === 'collected' ?
                                e('div', { className: "overflow-x-auto" }, collectedLocations.length > 0 ? e('table', { className: "min-w-full divide-y divide-slate-200" },
                                    e('thead', { className: "bg-slate-100" }, e('tr', null,
                                        e('th', { scope: "col", className: "table-header-cell" }, "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹"),
                                        e('th', { scope: "col", className: "table-header-cell" }, "Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©"),
                                        e('th', { scope: "col", className: "table-header-cell" }, "Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª"),
                                        e('th', { scope: "col", className: "table-header-cell" }, "ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"),
                                        e('th', { scope: "col", className: "relative px-6 py-3" }, e('span', { className: "sr-only" }, "Edit"))
                                    )),
                                    e('tbody', { className: "bg-white divide-y divide-slate-100" },
                                        collectedLocations.map((record, index) => e('tr', { key: record.id, className: index % 2 === 0 ? 'bg-white' : 'bg-slate-50 hover:bg-slate-100' },
                                            e('td', { className: "table-body-cell" }, e('div', { className: "text-sm text-slate-900 font-medium" }, record.locationName)),
                                            e('td', { className: "table-body-cell" }, e('div', { className: "text-sm text-slate-500" }, record.governate)),
                                            e('td', { className: "table-body-cell text-sm text-slate-500" }, e('div', { className: "font-mono" }, `Lat: ${record.latitude}`), e('div', { className: "font-mono" }, `Lon: ${record.longitude}`)),
                                            e('td', { className: "table-body-cell text-sm text-slate-500" }, record.timestamp),
                                            e('td', { className: "table-body-cell text-right text-sm font-medium flex gap-4 justify-end" },
                                                e('button', { onClick: () => handleShowQrCode(record), className: "text-emerald-600 hover:text-emerald-900 font-semibold" }, "Ø±Ù…Ø² QR"),
                                                e('button', { onClick: () => handleEdit(record), className: "text-indigo-600 hover:text-indigo-900 font-semibold" }, "ØªØ¹Ø¯ÙŠÙ„"),
                                                e('button', { onClick: () => handleDelete(record.id), className: "text-rose-600 hover:text-rose-900 font-semibold" }, "Ø­Ø°Ù")
                                            )
                                        ))
                                    )
                                ) : e(EmptyState, { message: "Ù„Ù… ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø©." }))
                            :
                                e('div', { className: "overflow-x-auto" }, pendingLocations.length > 0 ? 
                                    e('table', { className: "min-w-full divide-y divide-slate-200" },
                                        e('thead', { className: "bg-slate-100" }, e('tr', null,
                                            e('th', { scope: "col", className: "table-header-cell" }, "Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©"),
                                            e('th', { scope: "col", className: "table-header-cell" }, "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹"),
                                            e('th', { scope: "col", className: "table-header-cell" }, "Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©"),
                                            e('th', { scope: "col", className: "table-header-cell" }, "Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹")
                                        )),
                                        e('tbody', { className: "bg-white divide-y divide-slate-100" },
                                            pendingLocations.map((record, index) => e('tr', { key: record.ID, className: index % 2 === 0 ? 'bg-white' : 'bg-slate-50 hover:bg-slate-100' },
                                                e('td', { className: "table-body-cell text-sm text-slate-500" }, record['Company Name']),
                                                e('td', { className: "table-body-cell text-sm text-slate-900 font-medium" }, record['Location Name']),
                                                e('td', { className: "table-body-cell text-sm text-slate-500" }, record['Governate']),
                                                e('td', { className: "table-body-cell text-sm text-slate-500" }, record['Location Type'])
                                            ))
                                        )
                                    ) : e(EmptyState, { message: "ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ØªÙ… ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹." })
                                )
                        )
                    )
                )
            );
        };

        // =====================================================================================
        // --- App.tsx ---
        // =====================================================================================
        const App = () => {
            const { useState, useEffect } = React;
            const [isAdmin, setIsAdmin] = useState(false);
            const [referenceData, setReferenceData] = useState([]);
            const [fileName, setFileName] = useState('');
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const db = window.firebase.database();
                const masterRef = db.ref('masterReference');
                
                const listener = masterRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.data) {
                        setReferenceData(data.data);
                        setFileName(data.fileName);
                    } else {
                        setReferenceData([]);
                        setFileName('');
                    }
                    setIsLoading(false);
                });
                
                return () => masterRef.off('value', listener);
            }, []);

            const handleAdminLogin = () => setIsAdmin(true);
            const handleAdminLogout = () => setIsAdmin(false);

            if (isLoading) {
                return e('div', { className: "flex items-center justify-center min-h-screen bg-slate-100" }, 
                    e('div', { className: "text-center" }, 
                        e('div', { role: 'status' },
                            e('svg', { 'aria-hidden': 'true', className: 'inline w-10 h-10 text-slate-300 animate-spin fill-indigo-600', viewBox: '0 0 100 101', fill: 'none', xmlns: 'http://www.w3.org/2000/svg' },
                                e('path', { d: 'M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z', fill: 'currentColor' }),
                                e('path', { d: 'M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z', fill: 'currentFill' })
                            ),
                            e('span', { className: 'sr-only' }, 'Loading...'),
                        ),
                        e('p', { className: "text-lg text-slate-600 mt-4" }, "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...")
                    )
                );
            }

            return e(CollectionPage, { isAdmin, onAdminLogin: handleAdminLogin, onAdminLogout: handleAdminLogout, referenceData, fileName });
        };
        
        // =====================================================================================
        // --- index.tsx ---
        // =====================================================================================
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(React.StrictMode, null, e(App)));
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
